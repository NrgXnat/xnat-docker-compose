version: '2'
services:
  xnat-web:
    build: ./xnat17
    ports:
      - "8081:8080"
    volumes:
      - ./xnat-home:/data/xnat/home
      - /var/run/docker.sock:/var/run/docker.sock
    links:
      - xnat-db
    environment:
      - XNAT_DATASOURCE_DRIVER=org.postgresql.Driver
      - XNAT_DATASOURCE_URL=jdbc:postgresql://xnat-db/xnat
      - XNAT_DATASOURCE_USERNAME=xnat
      - XNAT_DATASOURCE_PASSWORD=xnat
      - XNAT_HIBERNATE_DIALECT=org.hibernate.dialect.PostgreSQL9Dialect
      - CATALINA_OPTS=-Xms128m -Xmx1024m -XX:MaxPermSize=256m

  xnat-db:
    build: ./postgres
    expose:
      - "5432"
    volumes:
      - ./postgres-data:/var/lib/postgresql/data

  xnat-nginx:
    build: ./nginx
    ports:
      - "80:80"
    expose:
      - "80"
    links:
      - xnat-web

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus/prometheus.yaml:/etc/prometheus/prometheus.yaml
    command:
      - '-config.file=/etc/prometheus/prometheus.yaml'
    ports:
      - '9090:9090'
    links:
      - cadvisor

  cadvisor:
    image: google/cadvisor
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    ports:
      - "8082:8080"
    expose:
      - 8082
